sudo apt install libinput-tools

libinput debug-events

sudo apt install evtest

evtest



## system/power

- 电源相关配置

用户维度配置，大多控制中心可设置

存储位置：/var/lib/dde-daemon/power/config.json

- cpu管理

用于设置性能模式

通过设置/sys/devices/system/cpu下的cpu配置文件实现

SetCpuBoost：设置高性能模式，对应配置/sys/devices/system/cpu/cpufreq/boost

SetGovernor：设置性能模式，对应配置/sys/devices/system/cpu/cpu?/cpufreq/scaling_governor

SetMode：手动性能模式，包含设置CpuBoost、Governor，关闭自动设置（包含使用电池自动节能等）。

- 笔记本盖子管理

通过gudev辅助/sys/devices，寻址盖子设备，通过监控设备文件来监控盖子事件；

system-daemon发送l盖子开关改变信号，session-daemon根据用户配置做对应响应；

- 电池管理

通过gudev获取到电池设备列表；

每个电池设备都单独导出到dbus（.../Power/Battery）；

每个电池设备开了一个定时器（目前60s），定时通过gudev获取电池信息，并触发system/power回调；

system/power回调实现了汇总所有电池设备信息，计算出通过dbus暴露给用户的电池信息；

通过gudev的uevent信号，可增删电池设备；

dde-dock的power插件，监控system/power的dbus的电量改变信号更新图标；

>gudev的底层，实际也是从sys文件获取的信息；
>
>搜索"power_supply"目录找到类似:
>
>/sys/devices/LNXSYSTM:00/LNXSYBUS:00/ACPI0003:00/power_supply/ACAD/subsystem/BAT1
>
>这就说电池设备的目录，
>
>feng09@feng09-PC:/sys/devices/LNXSYSTM:00/LNXSYBUS:00/ACPI0003:00/power_supply/ACAD/subsystem/BAT1$ ls
>alarm                           charge_full         device        present        type
>capacity                        charge_full_design  hwmon2        serial_number  uevent
>capacity_level                  charge_now          manufacturer  status         voltage_min_design
>charge_control_end_threshold    current_now         model_name    subsystem      voltage_now
>charge_control_start_threshold  cycle_count         power         technology
>feng09@feng09-PC:/sys/devices/LNXSYSTM:00/LNXSYBUS:00/ACPI0003:00/power_supply/ACAD/subsystem/BAT1$ cat charge_full
>6419000
>feng09@feng09-PC:/sys/devices/LNXSYSTM:00/LNXSYBUS:00/ACPI0003:00/power_supply/ACAD/subsystem/BAT1$ cat charge_now 
>5124000
>
>charge_now/charge_full * 100计算电量百分比

- 电源（AC）管理

通过gudev获取到电源设备，根据AC在线状态判断电源拔插；

拔掉电源，根据一些配置判断是否开启节能模式；

通过gudev的uevent信号，可触发插拔处理；



## session/power

维护用户级的电源相关配置，保存于gsettings/dconfig

监控system/power信号，根据用户配置，作出相关响应

- 合盖操作

session/power保存配置到gsettings/dcongf，session/power的LidSwitchHandler监控system/power盖子改变信号，根据power保存的配置进行对应操作

- 电源键操作

session/power保存配置到gsettings/dcongf，keybing的handlePower响应按键事件，根据power保存的配置进行对应操作

- 待机恢复要密码

XXX

- 唤醒显示器要密码

需要密码实际就说触发下锁屏。session/power保存配置到gsettings/dcongf，keybing的systemTurnOffScreen响应息屏事件，触发锁屏

- 低电量通知

～～～～

- 定时操作

定时操作是设置一个时间，空闲状态超过这个时间则触发操作，如关闭显示器、待机、锁屏等

（1）metaTasks

元任务，创建定时任务，创建时没有实际开始定时，优先级：

判断休眠、待机、屏保、锁屏、关闭显示器等任务能否加入任务队列

优先级为：休眠 > 待机=屏保 > 锁屏=关闭显示器

根据优先级决定是否创建任务，规则在power_save_plan.go的canAddToTasks()

（2）空闲判断

session/power根据metaTasks任务列表的等待最小时间，调用org.freedesktop.ScreenSaver的SetTimeout()设置最小时间。

闲时判断由org.freedesktop.ScreenSaver判断，空闲时间达到SetTimeout设置的时间发送IdleOn信号

（3）DelayedTasks

实际定时任务，创建后开启定时，到实际触发相关操作；

session/power收到IdleOn信号触发HandleIdleOn()，HandleIdleOn创建DelayedTasks。



## 相关电源操作

手动触发：keybinding/special_keycode.go的handlePower

自动触发：session/power/power_save_plan.go的Update

- 休眠

  休眠只有手动触发，调用dde-lock的com.deepin.dde.shutdownFront.Hibernate；

  dde-lock又会调用startdde的com.deepin.SessionManager.RequestHibernate实现休眠；

  startdde通过调用systemd接口和窗管接口来实现；

- 待机

  为了处理待机闪屏的问题，通过前端进行待机，前端会在待机前显示一个纯黑的界面；

  调用dde-lock的com.deepin.dde.shutdownFront.Suspend；

  dde-lock又会调用startdde的com.deepin.SessionManager.RequestSuspend实现待机；

- 屏保

  调用com.deepin.ScreenSaver.Start

- 关闭显示器

  降低显示器亮度，最终关闭显示器；

  先降低一半亮度，调用startdde的com.deepin.daemon.Display.SetBrightness，

  再锁屏，

  再设置亮度为0.02，

  最后调用窗管接口待机，wayland（dde_wldpms -s Off），X11（go-x11-client.ForceLevelChecked）

- 自动锁屏

  调用dde-lock的com.deepin.dde.lockFront.ShowAuth

- 关机

  调用startdde的com.deepin.SessionManager.RequestShutdown



